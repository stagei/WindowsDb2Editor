<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Visual Designer</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #toolbar {
            background: #252526;
            border-bottom: 1px solid #3c3c3c;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #1177bb;
        }

        button:disabled {
            background: #3c3c3c;
            color: #666;
            cursor: not-allowed;
        }

        #container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #3c3c3c;
        }

        #editor {
            flex: 1;
            padding: 10px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            border: none;
            resize: none;
            outline: none;
        }

        #preview-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: auto;
            background: #2d2d30;
            padding: 20px;
        }

        #mermaid-preview {
            min-height: 400px;
        }

        #diff-panel {
            background: #252526;
            border-top: 1px solid #3c3c3c;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        #diff-panel.visible {
            display: block;
        }

        .diff-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }

        .diff-added {
            background: #1a3d1a;
            border-left: 3px solid #4ec9b0;
        }

        .diff-removed {
            background: #3d1a1a;
            border-left: 3px solid #f48771;
        }

        .diff-modified {
            background: #3d3d1a;
            border-left: 3px solid #dcdcaa;
        }

        #status-bar {
            background: #007acc;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .status-info {
            display: flex;
            gap: 15px;
        }

        .clickable-table {
            cursor: pointer;
        }

        .clickable-table:hover {
            opacity: 0.8;
        }

        #help-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: #252526;
            border-left: 1px solid #3c3c3c;
            transition: right 0.3s;
            overflow-y: auto;
            padding: 20px;
            z-index: 1000;
        }

        #help-panel.visible {
            right: 0;
        }

        .help-section {
            margin-bottom: 20px;
        }

        .help-section h3 {
            color: #4ec9b0;
            margin-bottom: 10px;
        }

        .help-section code {
            background: #1e1e1e;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', monospace;
        }

        .help-section pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button onclick="refreshPreview()">üîÑ Refresh</button>
        <button onclick="autoRefresh()">‚ö° Auto-Refresh</button>
        <button onclick="generateFromDB()">üîΩ Load from DB</button>
        <button onclick="showDiff()">üìä Show Diff</button>
        <button onclick="generateDDL()">üìù Generate DDL</button>
        <button onclick="exportDiagram()">üíæ Export</button>
        <!-- NEW SqlMermaidErdTools Features -->
        <button onclick="generateSqlFromMermaid()">üîß Mermaid ‚Üí SQL</button>
        <button onclick="translateSqlDialog()">üåê Translate SQL</button>
        <button onclick="generateMigrationAdvanced()">‚öôÔ∏è Advanced Migration</button>
        <button onclick="toggleHelp()">‚ùì Help</button>
        <span style="margin-left: auto; color: #d4d4d4;">Mermaid ER Diagram Designer (SqlMermaidErdTools)</span>
    </div>

    <div id="container">
        <div id="editor-pane">
            <textarea id="editor" placeholder="Enter Mermaid ER diagram code here...">erDiagram
    CUSTOMER ||--o{ ORDER : places
    CUSTOMER {
        VARCHAR(50) CUSTOMER_ID PK
        VARCHAR(100) NAME
        VARCHAR(200) EMAIL
        DATE CREATED_DATE
    }
    ORDER {
        VARCHAR(50) ORDER_ID PK
        VARCHAR(50) CUSTOMER_ID FK
        DECIMAL(10,2) AMOUNT
        DATE ORDER_DATE
    }</textarea>
            <div id="diff-panel"></div>
        </div>

        <div id="preview-pane">
            <div id="mermaid-preview"></div>
        </div>
    </div>

    <div id="status-bar">
        <div class="status-info">
            <span id="status-text">Ready</span>
            <span id="table-count">Tables: 0</span>
            <span id="change-count">Changes: 0</span>
        </div>
        <div>
            <span>Click table names to view properties</span>
        </div>
    </div>

    <div id="help-panel">
        <h2 style="color: #4ec9b0; margin-bottom: 20px;">Mermaid ER Diagram Help</h2>
        
        <div class="help-section">
            <h3>Basic Syntax</h3>
            <pre>erDiagram
    TABLE_NAME {
        datatype columnname PK
        datatype columnname FK
    }</pre>
        </div>

        <div class="help-section">
            <h3>Relationships</h3>
            <code>||--o{</code> One to many<br>
            <code>||--||</code> One to one<br>
            <code>}o--o{</code> Many to many<br>
            <code>}o--||</code> Many to one
        </div>

        <div class="help-section">
            <h3>Column Markers</h3>
            <code>PK</code> - Primary Key<br>
            <code>FK</code> - Foreign Key<br>
            <code>UK</code> - Unique Key
        </div>

        <div class="help-section">
            <h3>DB2 Data Types</h3>
            <code>VARCHAR(n)</code><br>
            <code>CHAR(n)</code><br>
            <code>INTEGER</code><br>
            <code>DECIMAL(p,s)</code><br>
            <code>DATE</code><br>
            <code>TIMESTAMP</code><br>
            <code>CLOB</code><br>
            <code>BLOB</code>
        </div>

        <div class="help-section">
            <h3>Comments</h3>
            <pre>TABLE_NAME {
    VARCHAR(50) NAME "Customer name"
}</pre>
        </div>

        <button onclick="toggleHelp()" style="width: 100%; margin-top: 20px;">Close Help</button>
    </div>

    <script>
        let originalDiagram = '';
        let autoRefreshEnabled = false;
        let autoRefreshTimer = null;

        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#4ec9b0',
                primaryTextColor: '#d4d4d4',
                primaryBorderColor: '#3c3c3c',
                lineColor: '#858585',
                secondaryColor: '#3c3c3c',
                tertiaryColor: '#252526'
            }
        });

        const editor = document.getElementById('editor');
        const preview = document.getElementById('mermaid-preview');
        const diffPanel = document.getElementById('diff-panel');
        const statusText = document.getElementById('status-text');
        const tableCountEl = document.getElementById('table-count');
        const changeCountEl = document.getElementById('change-count');

        async function refreshPreview() {
            const code = editor.value;
            try {
                preview.innerHTML = '';
                const { svg } = await mermaid.render('mermaid-diagram', code);
                preview.innerHTML = svg;
                
                addTableClickHandlers();
                updateTableCount(code);
                statusText.textContent = 'Preview updated';
                statusText.style.color = '#4ec9b0';
            } catch (error) {
                preview.innerHTML = `<div style="color: #f48771; padding: 20px;">
                    <strong>Error rendering diagram:</strong><br>
                    ${error.message}
                </div>`;
                statusText.textContent = 'Error';
                statusText.style.color = '#f48771';
            }
        }

        function addTableClickHandlers() {
            const tables = preview.querySelectorAll('.er.entityBox');
            tables.forEach(table => {
                table.style.cursor = 'pointer';
                table.addEventListener('click', function() {
                    const tableName = this.querySelector('text').textContent;
                    openTableProperties(tableName);
                });
            });
        }

        function openTableProperties(tableName) {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    action: 'openTableProperties',
                    tableName: tableName
                });
            }
        }

        function updateTableCount(code) {
            const matches = code.match(/^\s*\w+\s*\{/gm);
            const count = matches ? matches.length : 0;
            tableCountEl.textContent = `Tables: ${count}`;
        }

        function autoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            
            if (autoRefreshEnabled) {
                statusText.textContent = 'Auto-refresh enabled';
                autoRefreshTimer = setInterval(refreshPreview, 2000);
            } else {
                statusText.textContent = 'Auto-refresh disabled';
                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                    autoRefreshTimer = null;
                }
            }
        }

        function generateFromDB() {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    action: 'generateFromDB'
                });
            }
        }

        function showDiff() {
            if (!originalDiagram) {
                originalDiagram = editor.value;
                statusText.textContent = 'Original version captured';
                return;
            }

            const currentDiagram = editor.value;
            
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    action: 'analyzeDiff',
                    original: originalDiagram,
                    edited: currentDiagram
                });
            }
        }

        function displayDiff(diffData) {
            diffPanel.innerHTML = '<h4 style="margin-bottom: 10px;">Schema Changes:</h4>';
            
            if (diffData.tableChanges.length === 0) {
                diffPanel.innerHTML += '<div class="diff-item">No changes detected</div>';
            } else {
                diffData.tableChanges.forEach(change => {
                    if (change.changeType === 1) { // Added
                        diffPanel.innerHTML += `<div class="diff-item diff-added">+ Table added: ${change.tableName}</div>`;
                    } else if (change.changeType === 2) { // Removed
                        diffPanel.innerHTML += `<div class="diff-item diff-removed">- Table removed: ${change.tableName}</div>`;
                    } else if (change.changeType === 3) { // Modified
                        change.addedColumns.forEach(col => {
                            diffPanel.innerHTML += `<div class="diff-item diff-added">+ ${change.tableName}.${col.columnName} (${col.newDataType})</div>`;
                        });
                        change.removedColumns.forEach(col => {
                            diffPanel.innerHTML += `<div class="diff-item diff-removed">- ${change.tableName}.${col.columnName}</div>`;
                        });
                        change.modifiedColumns.forEach(col => {
                            diffPanel.innerHTML += `<div class="diff-item diff-modified">~ ${change.tableName}.${col.columnName}: ${col.oldDataType} ‚Üí ${col.newDataType}</div>`;
                        });
                    }
                });
            }
            
            changeCountEl.textContent = `Changes: ${diffData.totalChanges}`;
            diffPanel.classList.add('visible');
        }

        function generateDDL() {
            if (!originalDiagram) {
                alert('Please capture original version first using "Show Diff" button');
                return;
            }

            const currentDiagram = editor.value;
            
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    action: 'generateDDL',
                    original: originalDiagram,
                    edited: currentDiagram
                });
            }
        }

        function exportDiagram() {
            const code = editor.value;
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    action: 'exportDiagram',
                    diagram: code
                });
            }
        }

        // NEW: SqlMermaidErdTools Features
        
        function generateSqlFromMermaid() {
            const diagram = editor.value;
            if (!diagram || diagram.trim().length === 0) {
                alert('Please enter a Mermaid diagram first');
                return;
            }
            
            const dialect = prompt(
                'Select SQL Dialect:\n\n' +
                '1. ANSI SQL (Standard)\n' +
                '2. SQL Server (T-SQL)\n' +
                '3. PostgreSQL\n' +
                '4. MySQL\n\n' +
                'Enter number (1-4):', '1'
            );
            
            if (!dialect) return;
            
            const dialectMap = {
                '1': 'AnsiSql',
                '2': 'SqlServer',
                '3': 'PostgreSql',
                '4': 'MySql'
            };
            
            const selectedDialect = dialectMap[dialect] || 'AnsiSql';
            
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    action: 'generateSqlFromMermaid',
                    diagram: diagram,
                    dialect: selectedDialect
                });
            }
            
            statusText.textContent = `Generating ${selectedDialect} SQL...`;
        }
        
        function showGeneratedSql(sql, dialect) {
            const newWindow = window.open('', '_blank', 'width=800,height=600');
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                    <head>
                        <title>Generated SQL DDL - ${dialect}</title>
                        <style>
                            body { font-family: 'Consolas', monospace; background: #1e1e1e; color: #d4d4d4; padding: 20px; }
                            pre { background: #252526; padding: 15px; border-radius: 4px; overflow-x: auto; }
                            h2 { color: #4ec9b0; }
                        </style>
                    </head>
                    <body>
                        <h2>Generated SQL DDL - ${dialect}</h2>
                        <pre>${sql}</pre>
                    </body>
                    </html>
                `);
                newWindow.document.close();
            }
            statusText.textContent = `SQL generated for ${dialect}`;
        }
        
        function translateSqlDialog() {
            const sourceSql = prompt('Enter source SQL to translate:');
            if (!sourceSql) return;
            
            const sourceDialect = prompt(
                'Source Dialect:\n\n' +
                '1. ANSI SQL\n' +
                '2. SQL Server\n' +
                '3. PostgreSQL\n' +
                '4. MySQL\n\n' +
                'Enter number:', '1'
            );
            
            const targetDialect = prompt(
                'Target Dialect:\n\n' +
                '1. ANSI SQL\n' +
                '2. SQL Server\n' +
                '3. PostgreSQL\n' +
                '4. MySQL\n\n' +
                'Enter number:', '3'
            );
            
            if (!sourceDialect || !targetDialect) return;
            
            const dialectMap = {
                '1': 'AnsiSql',
                '2': 'SqlServer',
                '3': 'PostgreSql',
                '4': 'MySql'
            };
            
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    action: 'translateSqlDialect',
                    sourceSql: sourceSql,
                    sourceDialect: dialectMap[sourceDialect] || 'AnsiSql',
                    targetDialect: dialectMap[targetDialect] || 'PostgreSql'
                });
            }
            
            statusText.textContent = 'Translating SQL...';
        }
        
        function showTranslatedSql(sql, sourceDialect, targetDialect) {
            const newWindow = window.open('', '_blank', 'width=800,height=600');
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                    <head>
                        <title>SQL Translation: ${sourceDialect} ‚Üí ${targetDialect}</title>
                        <style>
                            body { font-family: 'Consolas', monospace; background: #1e1e1e; color: #d4d4d4; padding: 20px; }
                            pre { background: #252526; padding: 15px; border-radius: 4px; overflow-x: auto; }
                            h2 { color: #4ec9b0; }
                        </style>
                    </head>
                    <body>
                        <h2>SQL Translation: ${sourceDialect} ‚Üí ${targetDialect}</h2>
                        <pre>${sql}</pre>
                    </body>
                    </html>
                `);
                newWindow.document.close();
            }
            statusText.textContent = `SQL translated: ${sourceDialect} ‚Üí ${targetDialect}`;
        }
        
        function generateMigrationAdvanced() {
            if (!originalDiagram) {
                alert('Please capture original version first using "Show Diff" button');
                return;
            }
            
            const currentDiagram = editor.value;
            
            const dialect = prompt(
                'Select Target SQL Dialect:\n\n' +
                '1. ANSI SQL\n' +
                '2. SQL Server\n' +
                '3. PostgreSQL\n' +
                '4. MySQL\n\n' +
                'Enter number:', '1'
            );
            
            if (!dialect) return;
            
            const dialectMap = {
                '1': 'AnsiSql',
                '2': 'SqlServer',
                '3': 'PostgreSql',
                '4': 'MySql'
            };
            
            const selectedDialect = dialectMap[dialect] || 'AnsiSql';
            
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    action: 'generateMigrationAdvanced',
                    original: originalDiagram,
                    edited: currentDiagram,
                    dialect: selectedDialect
                });
            }
            
            statusText.textContent = `Generating migration DDL (${selectedDialect})...`;
        }
        
        function showMigrationDdl(ddl, dialect) {
            const newWindow = window.open('', '_blank', 'width=800,height=600');
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                    <head>
                        <title>Migration DDL - ${dialect}</title>
                        <style>
                            body { font-family: 'Consolas', monospace; background: #1e1e1e; color: #d4d4d4; padding: 20px; }
                            pre { background: #252526; padding: 15px; border-radius: 4px; overflow-x: auto; }
                            h2 { color: #4ec9b0; }
                            .warning { color: #f48771; background: #3d1a1a; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
                        </style>
                    </head>
                    <body>
                        <h2>Migration DDL - ${dialect}</h2>
                        <div class="warning">‚ö†Ô∏è WARNING: Review carefully before executing! Some operations may be destructive.</div>
                        <pre>${ddl}</pre>
                    </body>
                    </html>
                `);
                newWindow.document.close();
            }
            statusText.textContent = `Migration DDL generated (${dialect})`;
        }
        
        function toggleHelp() {
            const helpPanel = document.getElementById('help-panel');
            helpPanel.classList.toggle('visible');
        }

        function setEditorContent(content) {
            editor.value = content;
            originalDiagram = content;
            refreshPreview();
        }

        editor.addEventListener('input', () => {
            if (autoRefreshEnabled) {
                // Debounced - will refresh via timer
            }
        });

        // Initialize
        refreshPreview();
    </script>
</body>
</html>


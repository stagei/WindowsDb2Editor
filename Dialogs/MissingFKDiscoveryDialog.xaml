<Window x:Class="WindowsDb2Editor.Dialogs.MissingFKDiscoveryDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.modernwpf.com/2019"
        ui:WindowHelper.UseModernWindowStyle="True"
        Title="Missing FK Discovery"
        Icon="pack://application:,,,/Resources/dEdge.ico"
        Width="900"
        Height="750"
        WindowStartupLocation="CenterOwner">
    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Title -->
        <TextBlock Grid.Row="0" Text="Missing Foreign Key Discovery" FontSize="18" FontWeight="Bold" Margin="0,0,0,15"/>
        
        <!-- Main Content: Left and Right Panels -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Left Panel: Table Selection -->
            <GroupBox Grid.Column="0" Header="Available Tables" Margin="0,0,5,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Schema Dropdown and Search -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                        <TextBlock Text="Schema:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <ComboBox x:Name="SchemaComboBox" Width="150" Margin="0,0,20,0" SelectionChanged="SchemaComboBox_SelectionChanged"/>
                        <TextBox x:Name="SearchTextBox" ui:ControlHelper.PlaceholderText="Search tables in selected schema..." Width="200" TextChanged="SearchTextBox_TextChanged"/>
                    </StackPanel>
                    
                    <!-- Action Buttons -->
                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
                        <Button Content="Add Selected" Click="AddSelected_Click" Padding="8,4" Margin="0,0,5,0"/>
                        <Button Content="Add All in Schema" Click="AddAllInSchema_Click" Padding="8,4" Margin="0,0,5,0"/>
                        <Button Content="Remove Selected" Click="RemoveSelected_Click" Padding="8,4"/>
                    </StackPanel>
                    
                    <!-- Table List -->
                    <Border Grid.Row="3" BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
                            BorderThickness="1" Padding="5">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <ItemsControl x:Name="TablesList">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}" Margin="5,4">
                                            <TextBlock Text="{Binding FullName}" FontSize="13"/>
                                        </CheckBox>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Border>
                    
                    <!-- Selection Count -->
                    <TextBlock Grid.Row="4" x:Name="LeftSelectionCountText" Margin="0,5,0,0" FontSize="12" Foreground="#AAAAAA"/>
                </Grid>
            </GroupBox>
            
            <!-- Splitter -->
            <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" Background="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
            
            <!-- Right Panel: Selected Tables -->
            <GroupBox Grid.Column="2" Header="Selected Tables" Margin="5,0,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Selected Tables List -->
                    <Border Grid.Row="0" BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
                            BorderThickness="1" Padding="5" Margin="0,0,0,10">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <ItemsControl x:Name="SelectedTablesList">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding FullName}" FontSize="13" Margin="5,4"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Border>
                    
                    <!-- FK Navigation Buttons -->
                    <StackPanel Grid.Row="1" Orientation="Vertical">
                        <Button x:Name="FollowFKButton" Content="Follow Foreign Keys →" Click="FollowFK_Click" 
                                Padding="10,5" Margin="0,0,0,5" ToolTip="Add tables referenced by selected tables"/>
                        <Button x:Name="FollowIncomingFKButton" Content="← Follow Incoming FKs" Click="FollowIncomingFK_Click" 
                                Padding="10,5" Margin="0,0,0,5" ToolTip="Add tables that reference selected tables"/>
                        <Button Content="Clear Selection" Click="ClearSelection_Click" Padding="10,5"/>
                    </StackPanel>
                </Grid>
            </GroupBox>
        </Grid>
        
        <!-- Bottom Panel: Options and Actions -->
        <GroupBox Grid.Row="2" Header="Options and Actions" Margin="0,15,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- File Paths -->
                <Grid Grid.Row="0" Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock Grid.Column="0" Text="Output Folder:" VerticalAlignment="Center" Margin="0,0,10,0" Width="100"/>
                    <TextBox Grid.Column="1" x:Name="OutputFolderTextBox" Margin="0,0,5,0" IsReadOnly="True"/>
                    <Button Grid.Column="2" Content="Browse..." Click="BrowseOutputFolder_Click" Padding="8,4" Width="80"/>
                </Grid>
                
                <Grid Grid.Row="1" Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock Grid.Column="0" Text="Ignore JSON:" VerticalAlignment="Center" Margin="0,0,10,0" Width="100"/>
                    <TextBox Grid.Column="1" x:Name="IgnoreJsonTextBox" Margin="0,0,5,0" IsReadOnly="True"/>
                    <Button Grid.Column="2" Content="Browse..." Click="BrowseIgnoreJson_Click" Padding="8,4" Width="80"/>
                </Grid>
                
                <!-- Ignore Column Editor -->
                <Expander x:Name="IgnoreColumnEditorExpander" Grid.Row="2" Header="Edit Ignore Rules" IsExpanded="False" Margin="0,0,0,10">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="200"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- History Dropdown -->
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Load from history:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                            <ComboBox x:Name="IgnoreHistoryComboBox" Width="300" 
                                    SelectionChanged="IgnoreHistoryComboBox_SelectionChanged"
                                    ui:ControlHelper.PlaceholderText="Select previous ignore list..."/>
                            <Button Content="Save Current" Click="SaveIgnoreConfig_Click" Padding="8,4" Margin="10,0,0,0"/>
                        </StackPanel>
                        
                        <!-- Ignore Column List -->
                        <TextBlock Grid.Row="1" Text="Ignore Columns (Schema.Table.Column):" Margin="0,0,0,5" FontWeight="SemiBold"/>
                        <DataGrid x:Name="IgnoreColumnsGrid" Grid.Row="2" 
                                AutoGenerateColumns="False" CanUserAddRows="True" CanUserDeleteRows="True"
                                HeadersVisibility="Column" GridLinesVisibility="All">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Schema" Binding="{Binding Schema}" Width="150"/>
                                <DataGridTextColumn Header="Table" Binding="{Binding Table}" Width="150"/>
                                <DataGridTextColumn Header="Column" Binding="{Binding Column}" Width="*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                        
                        <!-- Additional ignore options -->
                        <StackPanel Grid.Row="3" Orientation="Vertical" Margin="0,10,0,0">
                            <TextBlock Text="Ignore Column Patterns (Regex):" FontWeight="SemiBold" Margin="0,0,0,5"/>
                            <TextBox x:Name="IgnorePatternsTextBox" AcceptsReturn="True" TextWrapping="Wrap" 
                                    Height="60" VerticalScrollBarVisibility="Auto"
                                    ui:ControlHelper.PlaceholderText="One pattern per line, e.g., ^TMP_, _HASH$"/>
                            <TextBlock Text="Ignore Data Types (comma-separated):" FontWeight="SemiBold" Margin="0,10,0,5"/>
                            <TextBox x:Name="IgnoreDataTypesTextBox" 
                                    ui:ControlHelper.PlaceholderText="BLOB, CLOB, XML"/>
                        </StackPanel>
                    </Grid>
                </Expander>
                
                <!-- Options -->
                <Grid Grid.Row="3" Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <StackPanel Grid.Column="0" Margin="0,0,10,0">
                        <TextBlock Text="Min Row Count:" Margin="0,0,0,5"/>
                        <TextBox x:Name="MinRowCountTextBox" Text="100" Width="100" HorizontalAlignment="Left"/>
                    </StackPanel>
                    
                    <StackPanel Grid.Column="1" Margin="0,0,10,0">
                        <TextBlock Text="Min Match Ratio:" Margin="0,0,0,5"/>
                        <TextBox x:Name="MinMatchRatioTextBox" Text="0.95" Width="100" HorizontalAlignment="Left"/>
                    </StackPanel>
                    
                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Max Parallel Tables:" Margin="0,0,0,5"/>
                        <TextBox x:Name="MaxParallelTablesTextBox" Text="4" Width="100" HorizontalAlignment="Left"/>
                    </StackPanel>
                </Grid>
                
                <!-- Status and Action Buttons -->
                <Grid Grid.Row="4">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <StackPanel Grid.Column="0" Orientation="Vertical">
                        <TextBlock x:Name="StatusText" Text="Ready" VerticalAlignment="Center" 
                                   FontSize="12" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                        <TextBlock x:Name="JobStatusText" Text="No job running" 
                                   FontSize="11" Foreground="Gray" FontWeight="SemiBold"/>
                    </StackPanel>
                    
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Content="Generate Input JSON" Click="GenerateInputJson_Click" Padding="12,6" Margin="0,0,5,0"/>
                        <Button x:Name="StartBatchJobButton" Content="Start Batch Job" Click="StartBatchJob_Click" 
                                Padding="12,6" Margin="0,0,5,0" IsEnabled="False"/>
                        <Button x:Name="ViewJobLogButton" Content="View Job Log" Click="ViewJobLog_Click" 
                                Padding="12,6" Margin="0,0,5,0" IsEnabled="False"/>
                        <Button Content="Open Output Folder" Click="OpenOutputFolder_Click" Padding="12,6" Margin="0,0,5,0"/>
                        <Button Content="Close" IsCancel="True" Padding="12,6"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </GroupBox>
        
        <!-- Loading Overlay -->
        <Grid x:Name="LoadingOverlay" Visibility="Collapsed" Background="#CC1E1E1E">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ui:ProgressRing IsActive="True" Width="60" Height="60"/>
                <TextBlock x:Name="LoadingText" Text="Processing..." FontSize="16" 
                           Foreground="White" Margin="0,15,0,0" HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Window>

<Window x:Class="WindowsDb2Editor.Dialogs.SettingsDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.modernwpf.com/2019"
        ui:WindowHelper.UseModernWindowStyle="True"
        Title="Settings" 
        SizeToContent="Height"
        Width="700"
        MinHeight="400"
        MaxHeight="900"
        MinWidth="700"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TabControl Grid.Row="0" Margin="10">
            <!-- Editor Tab -->
            <TabItem Header="ðŸ“ Editor">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="20">
                        <TextBlock Text="Editor Settings" FontSize="18" FontWeight="Bold" Margin="0,0,0,20"/>

                        <!-- Theme -->
                        <TextBlock Text="Theme:" FontWeight="SemiBold" Margin="0,10,0,5"/>
                        <ComboBox x:Name="ThemeComboBox" Width="200" HorizontalAlignment="Left">
                            <ComboBoxItem Content="System" Tag="System"/>
                            <ComboBoxItem Content="Light" Tag="Light"/>
                            <ComboBoxItem Content="Dark" Tag="Dark"/>
                        </ComboBox>
                        <TextBlock Text="Theme preference (Ctrl+D to cycle)" 
                                   FontSize="11" Foreground="Gray" Margin="0,3,0,0"/>

                        <!-- Font Family -->
                        <TextBlock Text="Font Family:" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <ComboBox x:Name="FontFamilyComboBox" Width="200" HorizontalAlignment="Left">
                            <ComboBoxItem Content="Consolas" Tag="Consolas"/>
                            <ComboBoxItem Content="Courier New" Tag="Courier New"/>
                            <ComboBoxItem Content="Cascadia Code" Tag="Cascadia Code"/>
                            <ComboBoxItem Content="Cascadia Mono" Tag="Cascadia Mono"/>
                            <ComboBoxItem Content="JetBrains Mono" Tag="JetBrains Mono"/>
                            <ComboBoxItem Content="Fira Code" Tag="Fira Code"/>
                        </ComboBox>

                        <!-- Font Size -->
                        <TextBlock Text="Font Size:" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <StackPanel Orientation="Horizontal">
                            <Slider x:Name="FontSizeSlider" 
                                    Width="200" 
                                    Minimum="8" 
                                    Maximum="24" 
                                    TickFrequency="1" 
                                    IsSnapToTickEnabled="True"
                                    VerticalAlignment="Center"/>
                            <TextBlock x:Name="FontSizeText" 
                                       Text="14" 
                                       Width="30" 
                                       VerticalAlignment="Center" 
                                       Margin="10,0,0,0"
                                       FontWeight="SemiBold"/>
                        </StackPanel>

                        <!-- Tab Size -->
                        <TextBlock Text="Tab Size (spaces):" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <StackPanel Orientation="Horizontal">
                            <Slider x:Name="TabSizeSlider" 
                                    Width="200" 
                                    Minimum="2" 
                                    Maximum="8" 
                                    TickFrequency="1" 
                                    IsSnapToTickEnabled="True"
                                    VerticalAlignment="Center"/>
                            <TextBlock x:Name="TabSizeText" 
                                       Text="4" 
                                       Width="30" 
                                       VerticalAlignment="Center" 
                                       Margin="10,0,0,0"
                                       FontWeight="SemiBold"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Database Tab -->
            <TabItem Header="ðŸ—„ï¸ Database">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="20">
                        <TextBlock Text="Database Settings" FontSize="18" FontWeight="Bold" Margin="0,0,0,20"/>

                        <!-- Max Rows Per Query -->
                        <TextBlock Text="Max Rows Per Query:" FontWeight="SemiBold" Margin="0,10,0,5"/>
                        <StackPanel Orientation="Horizontal">
                            <TextBox x:Name="MaxRowsTextBox" 
                                     Width="150" 
                                     Height="32"
                                     VerticalContentAlignment="Center"
                                     HorizontalAlignment="Left"/>
                            <TextBlock Text="(Use pagination for larger results)" 
                                       FontSize="11" 
                                       Foreground="Gray" 
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0"/>
                        </StackPanel>

                        <!-- Command Timeout -->
                        <TextBlock Text="Command Timeout (seconds):" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <StackPanel Orientation="Horizontal">
                            <TextBox x:Name="CommandTimeoutTextBox" 
                                     Width="150" 
                                     Height="32"
                                     VerticalContentAlignment="Center"
                                     HorizontalAlignment="Left"/>
                            <TextBlock Text="(0 = no timeout)" 
                                       FontSize="11" 
                                       Foreground="Gray" 
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0"/>
                        </StackPanel>

                        <!-- Handle Decimal Errors -->
                        <CheckBox x:Name="HandleDecimalErrorsCheckBox" 
                                  Content="Handle decimal format errors gracefully" 
                                  Margin="0,20,0,5"/>
                        <TextBlock Text="Automatically fallback to string reading for problematic decimal values" 
                                   FontSize="11" 
                                   Foreground="Gray" 
                                   Margin="20,0,0,0"/>

                        <!-- Auto-Refresh Objects -->
                        <CheckBox x:Name="AutoRefreshObjectsCheckBox" 
                                  Content="Auto-refresh database objects on connect" 
                                  Margin="0,20,0,5"/>
                        <TextBlock Text="Automatically load tables, views, and schemas when connecting" 
                                   FontSize="11" 
                                   Foreground="Gray" 
                                   Margin="20,0,0,0"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Logging Tab -->
            <TabItem Header="ðŸ“‹ Logging">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="20">
                        <TextBlock Text="Logging Settings" FontSize="18" FontWeight="Bold" Margin="0,0,0,20"/>

                        <!-- Log Level -->
                        <TextBlock Text="Log Level:" FontWeight="SemiBold" Margin="0,10,0,5"/>
                        <ComboBox x:Name="LogLevelComboBox" Width="200" HorizontalAlignment="Left">
                            <ComboBoxItem Content="Debug" Tag="Debug"/>
                            <ComboBoxItem Content="Info" Tag="Info"/>
                            <ComboBoxItem Content="Warn" Tag="Warn"/>
                            <ComboBoxItem Content="Error" Tag="Error"/>
                        </ComboBox>
                        <TextBlock Text="Minimum level to log (Debug = most verbose)" 
                                   FontSize="11" Foreground="Gray" Margin="0,3,0,0"/>

                        <!-- Open Logs Folder -->
                        <TextBlock Text="Log Files Location:" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <Button x:Name="OpenLogsButton" 
                                Content="ðŸ“‚ Open Logs Folder" 
                                Width="200" 
                                HorizontalAlignment="Left"
                                Click="OpenLogsButton_Click"
                                Padding="10,5"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Data Files Tab -->
            <TabItem Header="ðŸ“ Data Files">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="20">
                        <TextBlock Text="Data Files Location" FontSize="18" FontWeight="Bold" Margin="0,0,0,20"/>

                        <!-- Info -->
                        <Border Background="{DynamicResource SystemControlBackgroundBaseLowBrush}" 
                                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                                BorderThickness="1"
                                Padding="15" 
                                Margin="0,0,0,20"
                                CornerRadius="4">
                            <StackPanel>
                                <TextBlock Text="â„¹ï¸ All application data is stored in your user profile" 
                                           FontWeight="SemiBold" 
                                           Margin="0,0,0,5"/>
                                <TextBlock x:Name="DataFolderPathText" 
                                           Text="" 
                                           TextWrapping="Wrap"
                                           FontSize="11"
                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                            </StackPanel>
                        </Border>

                        <!-- Files List -->
                        <TextBlock Text="Configuration Files:" FontWeight="SemiBold" Margin="0,10,0,10"/>
                        <StackPanel Margin="10,0,0,0">
                            <TextBlock Text="â€¢ connections.json - Saved database connections (encrypted)" Margin="0,3"/>
                            <TextBlock Text="â€¢ preferences.json - Application preferences" Margin="0,3"/>
                            <TextBlock Text="â€¢ queryhistory.json - Query execution history (encrypted)" Margin="0,3"/>
                        </StackPanel>

                        <!-- Open Data Folder Button -->
                        <Button x:Name="OpenDataFolderButton" 
                                Content="ðŸ“‚ Open Data Folder" 
                                Width="200" 
                                HorizontalAlignment="Left"
                                Margin="0,20,0,0"
                                Click="OpenDataFolderButton_Click"
                                Padding="10,5"
                                FontSize="14"
                                FontWeight="SemiBold"/>

                        <!-- Warning -->
                        <Border Background="{DynamicResource SystemControlBackgroundBaseLowBrush}" 
                                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                                BorderThickness="1"
                                Padding="15" 
                                Margin="0,20,0,0"
                                CornerRadius="4">
                            <StackPanel>
                                <TextBlock Text="âš ï¸ Warning" 
                                           FontWeight="Bold" 
                                           Margin="0,0,0,5"/>
                                <TextBlock Text="Manually editing these files may cause data loss or application errors. Always backup before making changes." 
                                           TextWrapping="Wrap"
                                           FontSize="11"
                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- AI Settings Tab -->
            <TabItem Header="ðŸ¤– AI">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="20">
                        <TextBlock Text="AI Provider Settings" FontSize="18" FontWeight="Bold" Margin="0,0,0,20"/>

                        <!-- AI Provider Selection -->
                        <TextBlock Text="AI Provider:" FontWeight="SemiBold" Margin="0,10,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <ComboBox Grid.Column="0" x:Name="AiProviderComboBox" Width="250" SelectionChanged="AiProvider_SelectionChanged">
                                <ComboBoxItem Content="Ollama (Local)" Tag="ollama" IsSelected="True"/>
                                <ComboBoxItem Content="LM Studio (Local)" Tag="lmstudio"/>
                                <ComboBoxItem Content="OpenAI (Cloud)" Tag="openai"/>
                                <ComboBoxItem Content="Azure OpenAI (Cloud)" Tag="azure"/>
                                <ComboBoxItem Content="Claude (Cloud)" Tag="claude"/>
                                <ComboBoxItem Content="Google Gemini (Cloud)" Tag="gemini"/>
                            </ComboBox>
                            <Button Grid.Column="1" x:Name="AutoDetectOllamaButton" Content="ðŸ” Auto-Detect" 
                                    Margin="10,0,0,0" Padding="10,5" Click="AutoDetectOllama_Click"/>
                        </Grid>
                        <TextBlock Text="Ollama and LM Studio are free, local AI options" 
                                   FontSize="11" Foreground="Gray" Margin="0,3,0,0"/>

                        <!-- Ollama Status Banner -->
                        <Border x:Name="OllamaStatusBorder" Background="#1E3A1E" CornerRadius="4" 
                                Padding="10" Margin="0,15,0,0" Visibility="Collapsed">
                            <StackPanel>
                                <TextBlock x:Name="OllamaStatusText" Text="âœ… Ollama detected" 
                                           FontWeight="SemiBold" Foreground="LightGreen"/>
                                <TextBlock x:Name="OllamaStatusDetails" Text="" 
                                           FontSize="11" Foreground="LightGray" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- Ollama Settings -->
                        <TextBlock Text="Ollama Endpoint:" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <TextBox x:Name="OllamaEndpointTextBox" 
                                 Width="300" 
                                 Height="32"
                                 VerticalContentAlignment="Center"
                                 HorizontalAlignment="Left"
                                 Text="http://localhost:11434"/>
                        <TextBlock Text="Default: http://localhost:11434" 
                                   FontSize="11" Foreground="Gray" Margin="0,3,0,0"/>

                        <!-- Model Selection (ComboBox for auto-detected, TextBox as fallback) -->
                        <TextBlock Text="Model:" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="300"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <ComboBox Grid.Column="0" x:Name="AiModelComboBox" Height="32" IsEditable="True"
                                      Text="llama3.2" Visibility="Collapsed"/>
                            <TextBox Grid.Column="0" x:Name="AiModelNameTextBox" 
                                     Width="300" 
                                     Height="32"
                                     VerticalContentAlignment="Center"
                                     HorizontalAlignment="Left"
                                     Text="llama3.2"/>
                            <Button Grid.Column="1" x:Name="RefreshModelsButton" Content="ðŸ”„" 
                                    ToolTip="Refresh available models"
                                    Margin="5,0,0,0" Padding="8,5" Click="RefreshModels_Click" Visibility="Collapsed"/>
                        </Grid>
                        <TextBlock Text="Examples: llama3.2, codellama, mistral, phi3" 
                                   FontSize="11" Foreground="Gray" Margin="0,3,0,0"/>

                        <!-- Available Models List (shown after auto-detect) -->
                        <Expander x:Name="AvailableModelsExpander" Header="Available Models (0)" 
                                  Margin="0,15,0,0" Visibility="Collapsed">
                            <ListBox x:Name="AvailableModelsList" MaxHeight="150" Margin="0,5,0,0"
                                     SelectionChanged="AvailableModelsList_SelectionChanged"/>
                        </Expander>

                        <!-- API Key (for cloud providers) -->
                        <TextBlock Text="API Key (Cloud Providers):" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <PasswordBox x:Name="AiApiKeyPasswordBox" 
                                     Width="300" 
                                     Height="32"
                                     VerticalContentAlignment="Center"
                                     HorizontalAlignment="Left"/>
                        <TextBlock Text="Required for OpenAI, Claude, Gemini. Stored securely." 
                                   FontSize="11" Foreground="Gray" Margin="0,3,0,0"/>

                        <!-- Test Connection -->
                        <Button x:Name="TestAiConnectionButton" 
                                Content="ðŸ§ª Test AI Connection" 
                                Width="200" 
                                HorizontalAlignment="Left"
                                Margin="0,20,0,0"
                                Click="TestAiConnection_Click"
                                Padding="10,5"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Font Size Settings Tab -->
            <TabItem Header="ðŸ”¤ Fonts">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="20">
                        <TextBlock Text="Font Size Settings" FontSize="18" FontWeight="Bold" Margin="0,0,0,20"/>

                        <!-- Object Browser Font Size -->
                        <TextBlock Text="Object Browser Font Size:" FontWeight="SemiBold" Margin="0,10,0,5"/>
                        <StackPanel Orientation="Horizontal">
                            <Slider x:Name="ObjectBrowserFontSizeSlider" 
                                    Width="200" 
                                    Minimum="8" 
                                    Maximum="24" 
                                    TickFrequency="1" 
                                    IsSnapToTickEnabled="True"
                                    VerticalAlignment="Center"
                                    Value="12"/>
                            <TextBlock x:Name="ObjectBrowserFontSizeText" 
                                       Text="12" 
                                       Width="30" 
                                       VerticalAlignment="Center" 
                                       Margin="10,0,0,0"
                                       FontWeight="SemiBold"/>
                        </StackPanel>

                        <!-- Dialog Font Size -->
                        <TextBlock Text="Dialog Font Size:" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <StackPanel Orientation="Horizontal">
                            <Slider x:Name="DialogFontSizeSlider" 
                                    Width="200" 
                                    Minimum="8" 
                                    Maximum="24" 
                                    TickFrequency="1" 
                                    IsSnapToTickEnabled="True"
                                    VerticalAlignment="Center"
                                    Value="14"/>
                            <TextBlock x:Name="DialogFontSizeText" 
                                       Text="14" 
                                       Width="30" 
                                       VerticalAlignment="Center" 
                                       Margin="10,0,0,0"
                                       FontWeight="SemiBold"/>
                        </StackPanel>

                        <!-- Menu Font Size -->
                        <TextBlock Text="Menu Font Size:" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <StackPanel Orientation="Horizontal">
                            <Slider x:Name="MenuFontSizeSlider" 
                                    Width="200" 
                                    Minimum="8" 
                                    Maximum="18" 
                                    TickFrequency="1" 
                                    IsSnapToTickEnabled="True"
                                    VerticalAlignment="Center"
                                    Value="12"/>
                            <TextBlock x:Name="MenuFontSizeText" 
                                       Text="12" 
                                       Width="30" 
                                       VerticalAlignment="Center" 
                                       Margin="10,0,0,0"
                                       FontWeight="SemiBold"/>
                        </StackPanel>

                        <!-- Status Bar Font Size -->
                        <TextBlock Text="Status Bar Font Size:" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <StackPanel Orientation="Horizontal">
                            <Slider x:Name="StatusBarFontSizeSlider" 
                                    Width="200" 
                                    Minimum="8" 
                                    Maximum="16" 
                                    TickFrequency="1" 
                                    IsSnapToTickEnabled="True"
                                    VerticalAlignment="Center"
                                    Value="11"/>
                            <TextBlock x:Name="StatusBarFontSizeText" 
                                       Text="11" 
                                       Width="30" 
                                       VerticalAlignment="Center" 
                                       Margin="10,0,0,0"
                                       FontWeight="SemiBold"/>
                        </StackPanel>

                        <!-- Property Window Font Size -->
                        <TextBlock Text="Property Window Font Size:" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <StackPanel Orientation="Horizontal">
                            <Slider x:Name="PropertyWindowFontSizeSlider" 
                                    Width="200" 
                                    Minimum="8" 
                                    Maximum="20" 
                                    TickFrequency="1" 
                                    IsSnapToTickEnabled="True"
                                    VerticalAlignment="Center"
                                    Value="12"/>
                            <TextBlock x:Name="PropertyWindowFontSizeText" 
                                       Text="12" 
                                       Width="30" 
                                       VerticalAlignment="Center" 
                                       Margin="10,0,0,0"
                                       FontWeight="SemiBold"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- Buttons -->
        <StackPanel Grid.Row="1" 
                    Orientation="Horizontal" 
                    HorizontalAlignment="Right" 
                    Margin="10">
            <Button Content="Reset to Defaults" 
                    Width="130" 
                    Height="32" 
                    Margin="0,0,10,0"
                    Click="ResetToDefaults_Click"/>
            <Button Content="Save" 
                    Width="100" 
                    Height="32" 
                    Margin="0,0,10,0"
                    Click="Save_Click"
                    IsDefault="True"
                    Style="{StaticResource AccentButtonStyle}"/>
            <Button Content="Cancel" 
                    Width="100" 
                    Height="32"
                    Click="Cancel_Click"
                    IsCancel="True"/>
        </StackPanel>
    </Grid>
</Window>
